{% extends "base.html" %}

{% block title %}QR Scanner - COMSOC Attendance System{% endblock %}

{% block content %}
<style>
    h2.section-title{font-weight:900;font-size:2rem;color:#f97316;font-style:italic;text-align:left}
    .card-like{background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);overflow:hidden;margin-bottom:16px}
    .card-like-header{padding:12px 16px;border-bottom:2px solid #f97316;background:#fff}
    .btn-primary-gradient{background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600}
    .btn-danger-grad{background:linear-gradient(135deg,#f56565,#e53e3e);color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600}
    .placeholder{border:2px dashed #f97316;border-radius:12px;padding:24px;background:#fff8f1}
    .result-box{border-radius:12px;padding:12px;margin-top:12px}
    .result-success{background:#ecfdf5;color:#065f46}
    .result-error{background:#fef2f2;color:#991b1b}
</style>

<div class="main-container">
    <div class="d-flex align-items-center mb-3" style="gap:10px">
        <a href="{{ url_for('attendance.view_record', record_id=record.record_id) }}" class="btn btn-outline-orange"><i class="fas fa-arrow-left me-2"></i>Back</a>
        <h2 class="section-title mb-0">QR Code Scanner</h2>
    </div>

    <div class="card-like">
        <div class="card-like-header"><strong><i class="fas fa-info-circle me-2"></i>Scanning for: {{ record.record_name }}</strong></div>
        <div class="p-3">
            <div class="row g-2">
                <div class="col-md-6"><strong>Record:</strong> {{ record.record_name }}</div>
                <div class="col-md-6"><strong>Event:</strong> {{ record.event.event_name }}</div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-center">
        <div class="card-like" style="max-width: 800px; width: 100%;">
            <div class="card-like-header"><strong><i class="fas fa-camera me-2"></i>Camera Scanner</strong></div>
            <div class="p-3 text-center">
                <div id="scanner-container">
                    <div id="camera-placeholder" class="placeholder">
                        <i class="fas fa-camera fa-3x mb-2" style="color:#f97316"></i>
                        <p class="mb-3">Click Start to activate your camera</p>
                        <button id="start-scanner" class="btn btn-primary-gradient"><i class="fas fa-play me-2"></i>Start Scanner</button>
                    </div>
                    <video id="video" style="display:none;width:100%;max-width:640px;border-radius:12px;margin:0 auto" autoplay></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <div class="mt-3">
                    <button id="stop-scanner" class="btn btn-danger-grad" style="display:none"><i class="fas fa-stop me-2"></i>Stop Scanner</button>
                </div>
                <div id="scan-result" class="result-box" style="display:none"></div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-0">
        <div class="col-md-6">
            <div class="card-like">
                <div class="card-like-header"><strong><i class="fas fa-info me-2"></i>Instructions</strong></div>
                <div class="p-3">
                    <ol class="mb-3">
                        <li>Click Start to activate your camera</li>
                        <li>Point the camera at a student's QR code</li>
                        <li>Scanning runs continuously and marks attendance automatically</li>
                        <li>Click Stop when finished</li>
                    </ol>
                    <div class="result-box" style="background:#fff8f1;color:#7c2d12">
                        <strong><i class="fas fa-lightbulb me-2"></i>Tips</strong>
                        <ul class="mb-0">
                            <li>Ensure good lighting</li>
                            <li>Hold the QR code steady</li>
                            <li>Keep the QR within the frame</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card-like">
                <div class="card-like-header"><strong><i class="fas fa-history me-2"></i>Recent Scans</strong></div>
                <div class="p-3" id="recent-scans">
                    <p class="text-muted mb-0">No scans yet</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let scanning = false;
let stream = null;
let recentScans = [];

document.getElementById('start-scanner').addEventListener('click', startScanner);
document.getElementById('stop-scanner').addEventListener('click', stopScanner);

async function startScanner() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 640 },
                height: { ideal: 480 }
            } 
        });
        
        video.srcObject = stream;
        video.style.display = 'block';
        document.getElementById('camera-placeholder').style.display = 'none';
        document.getElementById('start-scanner').style.display = 'none';
        document.getElementById('stop-scanner').style.display = 'inline-block';
        
        scanning = true;
        scan();
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Error accessing camera. Please ensure camera permissions are granted.');
    }
}

function stopScanner() {
    scanning = false;
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    
    video.style.display = 'none';
    document.getElementById('camera-placeholder').style.display = 'block';
    document.getElementById('start-scanner').style.display = 'inline-block';
    document.getElementById('stop-scanner').style.display = 'none';
}

function scan() {
    if (!scanning) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            processQRCode(code.data);
        }
    }
    
    requestAnimationFrame(scan);
}

function processQRCode(qrData) {
    // Stop scanning temporarily to prevent multiple scans
    scanning = false;
    
    fetch('{{ url_for("scanner.process_qr") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            qr_data: qrData,
            record_id: {{ record.record_id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        showScanResult(data);
        if (data.success) {
            addRecentScan(data.student);
        }
    })
    .catch(error => {
        console.error('Error processing QR code:', error);
        showScanResult({
            success: false,
            message: 'Error processing QR code'
        });
    })
    .finally(() => {
        // Resume scanning after a short delay
        setTimeout(() => {
            scanning = true;
            scan();
        }, 2000);
    });
}

function showScanResult(result){
    const box=document.getElementById('scan-result');
    if(result.success){
        box.className='result-box result-success';
        box.innerHTML=`<strong>Attendance Recorded!</strong><br><small>${result.student.name} (${result.student.id}) - ${result.student.course}</small>`;
    } else {
        box.className='result-box result-error';
        box.innerHTML=`<strong>Scan Failed</strong><br><small>${result.message}</small>`;
    }
    box.style.display='block';
}

function addRecentScan(student) {
    recentScans.unshift({
        name: student.name,
        id: student.id,
        time: new Date().toLocaleTimeString()
    });
    
    // Keep only last 5 scans
    if (recentScans.length > 5) {
        recentScans = recentScans.slice(0, 5);
    }
    
    updateRecentScansDisplay();
}

function updateRecentScansDisplay() {
    const container = document.getElementById('recent-scans');
    
    if (recentScans.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No scans yet</p>';
        return;
    }
    
    container.innerHTML = recentScans.map(scan => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <strong>${scan.name}</strong><br>
                <small class="text-muted">${scan.id}</small>
            </div>
            <small class="text-muted">${scan.time}</small>
        </div>
    `).join('');
}
</script>
{% endblock %}
